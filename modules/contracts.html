<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý hợp đồng - Mini ERP/CRM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="module-page">
        <div class="content-header">
            <h2>Quản lý hợp đồng</h2>
            <button class="btn-primary" onclick="openAddModal()">
                <i class="fas fa-plus"></i> Tạo hợp đồng
            </button>
        </div>

        <div class="info-box">
            <h4><i class="fas fa-info-circle"></i> Quy trình hợp đồng</h4>
            <p>Nháp → Chờ duyệt Trưởng phòng → Chờ duyệt Giám đốc → Chờ duyệt Pháp chế → Đã ký → Đang thực hiện → Hoàn thành</p>
        </div>

        <div class="search-filter">
            <input type="text" class="search-input" id="searchInput" placeholder="Tìm kiếm hợp đồng...">
            <select class="filter-select" id="filterStatus">
                <option value="">Tất cả trạng thái</option>
                <option value="draft">Nháp</option>
                <option value="pending_manager">Chờ duyệt TP</option>
                <option value="pending_director">Chờ duyệt GĐ</option>
                <option value="pending_legal">Chờ duyệt Pháp chế</option>
                <option value="signed">Đã ký</option>
                <option value="executing">Đang thực hiện</option>
                <option value="completed">Hoàn thành</option>
                <option value="cancelled">Đã hủy</option>
            </select>
            <button class="btn-secondary" onclick="exportData()">
                <i class="fas fa-file-export"></i> Xuất Excel
            </button>
        </div>

        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>Số hợp đồng</th>
                        <th>Khách hàng</th>
                        <th>Loại HĐ</th>
                        <th>Ngày ký</th>
                        <th>Giá trị</th>
                        <th>Tiến độ</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Tạo hợp đồng mới</h3>
            
            <form id="dataForm" onsubmit="saveData(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Số hợp đồng <span class="required">*</span></label>
                        <input type="text" name="code" required placeholder="HĐ-">
                    </div>
                    <div class="form-group">
                        <label>Loại hợp đồng <span class="required">*</span></label>
                        <select name="type" required>
                            <option value="">Chọn loại...</option>
                            <option value="sale">Hợp đồng bán hàng</option>
                            <option value="service">Hợp đồng dịch vụ</option>
                            <option value="project">Hợp đồng dự án</option>
                            <option value="other">Khác</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Khách hàng <span class="required">*</span></label>
                        <select name="customer" required>
                            <option value="">Chọn khách hàng</option>
                            <option value="Công ty TNHH ABC">Công ty TNHH ABC</option>
                            <option value="Công ty CP XYZ">Công ty CP XYZ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Báo giá liên quan</label>
                        <select name="quotation">
                            <option value="">Chọn báo giá...</option>
                            <option value="BG001">BG001 - Công ty ABC</option>
                            <option value="BG002">BG002 - Công ty XYZ</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ngày ký <span class="required">*</span></label>
                        <input type="date" name="signDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ngày hiệu lực <span class="required">*</span></label>
                        <input type="date" name="effectiveDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ngày hết hạn</label>
                        <input type="date" name="expiryDate">
                    </div>
                    <div class="form-group">
                        <label>Giá trị hợp đồng <span class="required">*</span></label>
                        <input type="number" name="value" required min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Tiêu đề hợp đồng <span class="required">*</span></label>
                    <input type="text" name="title" required placeholder="VD: Hợp đồng cung cấp thiết bị văn phòng">
                </div>

                <div class="form-group">
                    <label>Điều khoản thanh toán</label>
                    <textarea name="paymentTerms" rows="3" placeholder="VD: Thanh toán 30% trước, 40% khi giao hàng, 30% sau nghiệm thu"></textarea>
                </div>

                <div class="form-group">
                    <label>Điều khoản giao hàng</label>
                    <textarea name="deliveryTerms" rows="2" placeholder="VD: Giao hàng trong vòng 30 ngày kể từ ngày ký hợp đồng"></textarea>
                </div>

                <div class="form-group">
                    <label>Điều khoản bảo hành</label>
                    <textarea name="warrantyTerms" rows="2" placeholder="VD: Bảo hành 12 tháng kể từ ngày nghiệm thu"></textarea>
                </div>

                <div class="form-group">
                    <label>Upload file hợp đồng</label>
                    <input type="file" name="contractFile" accept=".pdf,.doc,.docx" onchange="handleFileUpload(this)">
                    <small style="color: #6c757d;">
                        <i class="fas fa-info-circle"></i> Chấp nhận file PDF, DOC, DOCX (tối đa 10MB)
                    </small>
                    <div id="uploadedFiles" style="margin-top: 10px;"></div>
                </div>

                <div class="form-group">
                    <label>Ghi chú</label>
                    <textarea name="note" rows="2"></textarea>
                </div>

                <input type="hidden" name="id">
                <input type="hidden" name="status" value="draft">

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Lưu nháp
                    </button>
                    <button type="button" class="btn-primary" onclick="saveAndSendForApproval()">
                        <i class="fas fa-paper-plane"></i> Gửi duyệt
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Phê duyệt -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeApprovalModal()">&times;</span>
            <h3>Phê duyệt hợp đồng</h3>
            
            <div id="contractInfo" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <!-- Contract info will be loaded here -->
            </div>

            <div style="margin-bottom: 15px;">
                <h4>Lịch sử phê duyệt:</h4>
                <div id="approvalHistory" style="border: 1px solid #dee2e6; padding: 10px; border-radius: 5px;">
                    <!-- Approval history will be loaded here -->
                </div>
            </div>

            <form id="approvalForm" onsubmit="handleApproval(event)">
                <div class="form-group">
                    <label>Quyết định <span class="required">*</span></label>
                    <select name="decision" required onchange="toggleRejectReason(this.value)">
                        <option value="">Chọn...</option>
                        <option value="approve">Phê duyệt</option>
                        <option value="reject">Từ chối</option>
                    </select>
                </div>

                <div class="form-group" id="rejectReasonGroup" style="display: none;">
                    <label>Lý do từ chối <span class="required">*</span></label>
                    <textarea name="rejectReason" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Ghi chú</label>
                    <textarea name="approvalNote" rows="2"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeApprovalModal()">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-check"></i> Xác nhận
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="contracts.js"></script>
    <script>
        function handleFileUpload(input) {
            const uploadedFiles = document.getElementById('uploadedFiles');
            if (input.files && input.files[0]) {
                const file = input.files[0];
                uploadedFiles.innerHTML = `
                    <div style="padding: 10px; background: #e7f3ff; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="fas fa-file-pdf"></i> ${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
                        <button type="button" class="btn-danger" onclick="removeFile()" style="padding: 5px 10px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
        }

        function removeFile() {
            document.querySelector('[name="contractFile"]').value = '';
            document.getElementById('uploadedFiles').innerHTML = '';
        }

        function closeApprovalModal() {
            document.getElementById('approvalModal').style.display = 'none';
        }

        function toggleRejectReason(decision) {
            const rejectReasonGroup = document.getElementById('rejectReasonGroup');
            if (decision === 'reject') {
                rejectReasonGroup.style.display = 'block';
                document.querySelector('[name="rejectReason"]').required = true;
            } else {
                rejectReasonGroup.style.display = 'none';
                document.querySelector('[name="rejectReason"]').required = false;
            }
        }

        function handleApproval(event) {
            event.preventDefault();
            alert('Đã xử lý phê duyệt!');
            closeApprovalModal();
        }

        function saveAndSendForApproval() {
            if (confirm('Bạn có chắc muốn gửi hợp đồng này để phê duyệt?')) {
                alert('Đã gửi hợp đồng để phê duyệt!');
                closeModal();
            }
        }
    </script>
</body>
</html>
