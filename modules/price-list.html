<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng giá sản phẩm - Mini ERP/CRM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="module-page">
        <div class="content-header">
            <h2>Bảng giá sản phẩm</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="openAddModal()">
                    <i class="fas fa-plus"></i> Thêm bảng giá
                </button>
                <button class="btn-primary" onclick="openImportModal()" style="background: #17a2b8; border-color: #17a2b8;">
                    <i class="fas fa-file-import"></i> Import Excel
                </button>
                <button class="btn-secondary" onclick="downloadTemplate()">
                    <i class="fas fa-download"></i> Tải Template
                </button>
            </div>
        </div>

        <div class="info-box">
            <h4><i class="fas fa-info-circle"></i> Quản lý bảng giá nâng cao</h4>
            <p>Hỗ trợ import từ Excel. Quản lý giá theo dự án, lô hàng, Bio/NCC, và khách hàng. Theo dõi lịch sử thay đổi giá.</p>
        </div>

        <!-- Tabs phân loại bảng giá -->
        <div class="tabs" style="margin-bottom: 20px;">
            <button class="tab-btn active" onclick="switchTab('all')">Tất cả</button>
            <button class="tab-btn" onclick="switchTab('project')">Giá theo dự án</button>
            <button class="tab-btn" onclick="switchTab('batch')">Giá theo lô hàng</button>
            <button class="tab-btn" onclick="switchTab('bio')">Giá theo Bio/NCC</button>
            <button class="tab-btn" onclick="switchTab('customer')">Giá theo khách hàng</button>
        </div>

        <div class="search-filter">
            <input type="text" class="search-input" id="searchInput" placeholder="Tìm kiếm bảng giá...">
            <select class="filter-select" id="filterType">
                <option value="">Tất cả loại</option>
                <option value="vip">Bảng giá VIP</option>
                <option value="normal">Bảng giá thường</option>
                <option value="promotion">Bảng giá khuyến mãi</option>
                <option value="project">Theo dự án</option>
                <option value="batch">Theo lô hàng</option>
                <option value="bio">Theo Bio/NCC</option>
                <option value="customer">Theo khách hàng</option>
            </select>
            <button class="btn-secondary" onclick="exportData()">
                <i class="fas fa-file-export"></i> Xuất Excel
            </button>
            <button class="btn-secondary" onclick="viewPriceHistory()">
                <i class="fas fa-history"></i> Lịch sử giá
            </button>
        </div>

        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>Mã bảng giá</th>
                        <th>Tên bảng giá</th>
                        <th>Loại</th>
                        <th>Ngày áp dụng</th>
                        <th>Ngày hết hạn</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Thêm/Sửa bảng giá -->
    <div id="modal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Thêm bảng giá mới</h3>
            
            <form id="dataForm" onsubmit="saveData(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Mã bảng giá <span class="required">*</span></label>
                        <input type="text" name="code" required>
                    </div>
                    <div class="form-group">
                        <label>Loại bảng giá <span class="required">*</span></label>
                        <select name="type" required onchange="handlePriceTypeChange(this.value)">
                            <option value="vip">Bảng giá VIP</option>
                            <option value="normal">Bảng giá thường</option>
                            <option value="promotion">Bảng giá khuyến mãi</option>
                            <option value="project">Theo dự án</option>
                            <option value="batch">Theo lô hàng</option>
                            <option value="bio">Theo Bio/NCC</option>
                            <option value="customer">Theo khách hàng</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tên bảng giá <span class="required">*</span></label>
                    <input type="text" name="name" required placeholder="VD: Bảng giá VIP Q4/2025">
                </div>

                <!-- Áp dụng cho (hiển thị tùy theo loại) -->
                <div class="form-group" id="applyForGroup" style="display: none;">
                    <label id="applyForLabel">Áp dụng cho <span class="required">*</span></label>
                    <select name="applyFor" id="applyForSelect">
                        <option value="">Chọn...</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ngày áp dụng <span class="required">*</span></label>
                        <input type="date" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ngày hết hạn <span class="required">*</span></label>
                        <input type="date" name="endDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Mô tả</label>
                    <textarea name="description" rows="2"></textarea>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #dee2e6;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4>Chi tiết giá sản phẩm</h4>
                    <div>
                        <button type="button" class="btn-secondary" onclick="addProductRow()">
                            <i class="fas fa-plus"></i> Thêm sản phẩm
                        </button>
                        <button type="button" class="btn-secondary" onclick="importProductsFromExcel()">
                            <i class="fas fa-file-import"></i> Import từ Excel
                        </button>
                    </div>
                </div>

                <div id="productList">
                    <div class="product-item" style="margin-bottom: 10px; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label>Sản phẩm</label>
                                <select name="products[0][name]" required>
                                    <option value="">Chọn sản phẩm</option>
                                    <option value="Laptop Dell XPS 15">Laptop Dell XPS 15</option>
                                    <option value="Màn hình LG 27 inch">Màn hình LG 27 inch</option>
                                    <option value="Bàn làm việc">Bàn làm việc</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Giá gốc</label>
                                <input type="number" name="products[0][originalPrice]" min="0" required>
                            </div>
                            <div class="form-group">
                                <label>Giá bán</label>
                                <input type="number" name="products[0][price]" min="0" required onchange="calculateDiscount(0)">
                            </div>
                            <div class="form-group">
                                <label>CK (%)</label>
                                <input type="number" name="products[0][discount]" min="0" max="100" value="0" readonly>
                            </div>
                            <div class="form-group" style="flex: 0.5;">
                                <label>&nbsp;</label>
                                <button type="button" class="btn-danger" onclick="removeProductRow(0)" style="width: 100%;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Lý do thay đổi giá (nếu có)</label>
                            <input type="text" name="products[0][reason]" placeholder="VD: Khuyến mãi cuối năm, Giá đặc biệt cho dự án X...">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ghi chú</label>
                    <textarea name="note" rows="2"></textarea>
                </div>

                <input type="hidden" name="id">

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                    <button type="button" class="btn-secondary" onclick="viewPriceHistoryForPriceList()">
                        <i class="fas fa-history"></i> Xem lịch sử
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import Excel -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeImportModal()">&times;</span>
            <h3>Import bảng giá từ Excel</h3>
            
            <form id="importForm" onsubmit="handleImport(event)">
                <div class="form-group">
                    <label>Chọn loại bảng giá <span class="required">*</span></label>
                    <select name="importType" required>
                        <option value="">Chọn loại...</option>
                        <option value="vip">Bảng giá VIP</option>
                        <option value="normal">Bảng giá thường</option>
                        <option value="promotion">Bảng giá khuyến mãi</option>
                        <option value="project">Theo dự án</option>
                        <option value="batch">Theo lô hàng</option>
                        <option value="bio">Theo Bio/NCC</option>
                        <option value="customer">Theo khách hàng</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Chọn file Excel <span class="required">*</span></label>
                    <input type="file" name="excelFile" accept=".xlsx,.xls" required onchange="previewExcel(this)">
                    <small style="color: #6c757d;">
                        <i class="fas fa-info-circle"></i> 
                        Chỉ chấp nhận file .xlsx hoặc .xls. 
                        <a href="#" onclick="downloadTemplate(); return false;">Tải template mẫu</a>
                    </small>
                </div>

                <div id="previewArea" style="display: none; margin-top: 15px;">
                    <h4>Preview dữ liệu:</h4>
                    <div style="max-height: 300px; overflow: auto; border: 1px solid #dee2e6; padding: 10px;">
                        <table id="previewTable" style="width: 100%; font-size: 12px;">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="validationErrors" style="margin-top: 10px;"></div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeImportModal()">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn-primary" id="importBtn" disabled>
                        <i class="fas fa-upload"></i> Import
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lịch sử giá -->
    <div id="historyModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h3>Lịch sử thay đổi giá</h3>
            
            <div class="search-filter" style="margin-bottom: 15px;">
                <input type="text" class="search-input" id="historySearch" placeholder="Tìm kiếm sản phẩm...">
                <select class="filter-select" id="historyFilter">
                    <option value="">Tất cả sản phẩm</option>
                </select>
            </div>

            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Ngày thay đổi</th>
                            <th>Sản phẩm</th>
                            <th>Bảng giá</th>
                            <th>Giá cũ</th>
                            <th>Giá mới</th>
                            <th>Thay đổi</th>
                            <th>Lý do</th>
                            <th>Người thay đổi</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closeHistoryModal()">
                    <i class="fas fa-times"></i> Đóng
                </button>
                <button type="button" class="btn-secondary" onclick="exportPriceHistory()">
                    <i class="fas fa-file-export"></i> Xuất Excel
                </button>
            </div>
        </div>
    </div>

    <script src="price-list.js"></script>
    <script>
        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // Filter data based on tab
            filterByTab(tab);
        }

        // Handle price type change
        function handlePriceTypeChange(type) {
            const applyForGroup = document.getElementById('applyForGroup');
            const applyForLabel = document.getElementById('applyForLabel');
            const applyForSelect = document.getElementById('applyForSelect');
            
            if (['project', 'batch', 'bio', 'customer'].includes(type)) {
                applyForGroup.style.display = 'block';
                applyForSelect.innerHTML = '<option value="">Chọn...</option>';
                
                switch(type) {
                    case 'project':
                        applyForLabel.innerHTML = 'Dự án <span class="required">*</span>';
                        applyForSelect.innerHTML += '<option value="DA001">Dự án ABC</option><option value="DA002">Dự án XYZ</option>';
                        break;
                    case 'batch':
                        applyForLabel.innerHTML = 'Lô hàng <span class="required">*</span>';
                        applyForSelect.innerHTML += '<option value="LOT001">Lô 001 - 01/2025</option><option value="LOT002">Lô 002 - 02/2025</option>';
                        break;
                    case 'bio':
                        applyForLabel.innerHTML = 'Bio/NCC <span class="required">*</span>';
                        applyForSelect.innerHTML += '<option value="BIO001">Bio A</option><option value="NCC001">NCC XYZ</option>';
                        break;
                    case 'customer':
                        applyForLabel.innerHTML = 'Khách hàng <span class="required">*</span>';
                        applyForSelect.innerHTML += '<option value="KH001">Công ty ABC</option><option value="KH002">Công ty XYZ</option>';
                        break;
                }
            } else {
                applyForGroup.style.display = 'none';
            }
        }

        // Calculate discount percentage
        function calculateDiscount(index) {
            const originalPrice = parseFloat(document.querySelector(`[name="products[${index}][originalPrice]"]`).value) || 0;
            const price = parseFloat(document.querySelector(`[name="products[${index}][price]"]`).value) || 0;
            
            if (originalPrice > 0) {
                const discount = ((originalPrice - price) / originalPrice * 100).toFixed(2);
                document.querySelector(`[name="products[${index}][discount]"]`).value = discount;
            }
        }

        // Remove product row
        function removeProductRow(index) {
            const productItem = event.target.closest('.product-item');
            if (document.querySelectorAll('.product-item').length > 1) {
                productItem.remove();
            } else {
                alert('Phải có ít nhất 1 sản phẩm!');
            }
        }

        // Import modal functions
        function openImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importForm').reset();
            document.getElementById('previewArea').style.display = 'none';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function viewPriceHistory() {
            document.getElementById('historyModal').style.display = 'block';
            loadPriceHistory();
        }

        function downloadTemplate() {
            alert('Đang tải template Excel...');
            // Implement download template logic
        }

        function previewExcel(input) {
            // Implement Excel preview logic
            if (input.files && input.files[0]) {
                document.getElementById('previewArea').style.display = 'block';
                document.getElementById('importBtn').disabled = false;
                // Parse and display Excel data
            }
        }

        function handleImport(event) {
            event.preventDefault();
            alert('Đang import dữ liệu...');
            // Implement import logic
            closeImportModal();
        }

        function loadPriceHistory() {
            // Load price history data
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Đang tải dữ liệu...</td></tr>';
        }

        if (typeof loadData === 'function') {
            loadData();
        }
    </script>
</body>
</html>
